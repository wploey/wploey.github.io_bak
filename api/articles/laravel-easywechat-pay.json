{"title":"Laravel EasyWechat 支付","slug":"laravel-easywechat-pay","date":"2017-06-01T07:36:58.000Z","updated":"2017-06-19T04:01:59.425Z","comments":true,"excerpt":"","content":"<p>整理下 Laravel EasyWechat 支付的相关代码，方便以后查看。</p>\n<h2 id=\"EasyWeChat-是什么？\"><a href=\"#EasyWeChat-是什么？\" class=\"headerlink\" title=\"EasyWeChat 是什么？\"></a>EasyWeChat 是什么？</h2><p>EasyWeChat 是一个开源的 <a href=\"http://www.wechat.com\" target=\"_blank\" rel=\"external\">微信</a> 非官方 SDK。</p>\n<p>EasyWeChat 的安装非常简单，因为它是一个标准的 Composer 包，这意味着任何满足下列安装条件的 PHP 项目支持 Composer 都可以使用它。</p>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>Github 地址： <a href=\"https://github.com/overtrue/laravel-wechat\" target=\"_blank\" rel=\"external\">overtrue/laravel-wechat</a></p>\n<blockquote>\n<p>composer require “overtrue/laravel-wechat:~3.0”</p>\n</blockquote>\n<h2 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h2><p>看文档，ENV 配置</p>\n<ul>\n<li>基本<ul>\n<li>WECHAT_APPID=wxeba163c4xxxxx</li>\n<li>WECHAT_SECRET=216d04f683afe852d84eded9xxxxx</li>\n<li>WECHAT_TOKEN=60166ea337d0d3d8f9b6be41xxxxx</li>\n<li>WECHAT_AES_KEY=a4hrTSdjWy8SPvxaVPqiFw2o9ZYTegLlbQzxxxxx</li>\n</ul>\n</li>\n<li>支付<ul>\n<li>WECHAT_PAYMENT_MERCHANT_ID=1300xxxxx</li>\n<li>WECHAT_PAYMENT_KEY=123skijik3412934lkllxxxxx</li>\n<li>WECHAT_PAYMENT_CERT_PATH=/path/apiclient_cert.pem</li>\n<li>WECHAT_PAYMENT_KEY_PATH=/path/apiclient_key.pem</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"ngrok\"><a href=\"#ngrok\" class=\"headerlink\" title=\"ngrok\"></a>ngrok</h2><p><img src=\"http://oqlezeown.bkt.clouddn.com/ngrok.png\" alt=\"ngrok\"></p>\n<blockquote>\n<p><a href=\"https://github.com/inconshreveable/ngrok\" target=\"_blank\" rel=\"external\">ngrok</a> 可以让我们使用公网访问本地程序，就先这样解释，官网提供的公共服务确实太慢了，这里我用 <a href=\"https://www.ngrok.cc\" target=\"_blank\" rel=\"external\">Sunny-Ngrok</a> 提供的，能用就行</p>\n</blockquote>\n<p>到 <a href=\"https://www.ngrok.cc\" target=\"_blank\" rel=\"external\">Sunny-Ngrok</a> 申请注册账号，开通隧道<br><img src=\"http://oqlezeown.bkt.clouddn.com/ngrok-1.jpg\" alt=\"\"></p>\n<blockquote>\n<p>下载 ngrok 客户端</p>\n<ul>\n<li><a href=\"http://hls.ctopus.com/sunny/linux_amd64.zip\" target=\"_blank\" rel=\"external\">Linux 64Bit版本</a></li>\n<li><a href=\"http://hls.ctopus.com/sunny/windows_amd64.zip\" target=\"_blank\" rel=\"external\">Windows 64Bit版本</a></li>\n<li>开启隧道 <code>$ ./sunny clientid 隧道id</code></li>\n<li>将自己拥有的域名通过CNAME的方式解析到服务器 server.ngrok.cc</li>\n<li>记得本地 nginx 需要有对应域名的配置</li>\n<li>ping 下域名看下 ip 指向 server.ngrok.cc 就成功了<br><img src=\"http://oqlezeown.bkt.clouddn.com/ngrok-2.png\" alt=\"\"></li>\n</ul>\n</blockquote>\n<h2 id=\"git-自动部署\"><a href=\"#git-自动部署\" class=\"headerlink\" title=\"git 自动部署\"></a>git 自动部署</h2><p>如果发现 ngrok 太慢了，就直接用服务器开发吧！！</p>\n<blockquote>\n<p><a href=\"https://aotu.io/notes/2017/04/10/githooks/\" target=\"_blank\" rel=\"external\">用 Git 钩子进行简单自动部署</a></p>\n</blockquote>\n<h2 id=\"Laravel\"><a href=\"#Laravel\" class=\"headerlink\" title=\"Laravel\"></a>Laravel</h2><p>Laravel Framework 5.4.18</p>\n<h2 id=\"微信路由\"><a href=\"#微信路由\" class=\"headerlink\" title=\"微信路由\"></a>微信路由</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">//微信token验证</div><div class=\"line\">Route::any(&apos;/wechat&apos;, &apos;Wechat\\WechatController@serve&apos;);</div><div class=\"line\">//根据openId获取用户信息</div><div class=\"line\">Route::get(&apos;/wx/users/&#123;openId&#125;&apos;, &apos;Wechat\\WxUsersController@user&apos;);</div></pre></td></tr></table></figure>\n<h2 id=\"微信token验证\"><a href=\"#微信token验证\" class=\"headerlink\" title=\"微信token验证\"></a>微信token验证</h2><p>project\\app\\Http\\Controllers\\Wechat\\WechatController.php<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ php artisan make:controller Wechat/WechatController #新建控制器</div><div class=\"line\"></div><div class=\"line\">project\\app\\Http\\Controllers\\Wechat\\WechatController.php</div><div class=\"line\"></div><div class=\"line\">/**</div><div class=\"line\"> * 处理微信的请求消息</div><div class=\"line\"> *</div><div class=\"line\"> * @return string</div><div class=\"line\"> */</div><div class=\"line\">public function serve()</div><div class=\"line\">&#123;</div><div class=\"line\">    $wechat = app(&apos;wechat&apos;);</div><div class=\"line\">    $userApi = $wechat-&gt;user;</div><div class=\"line\">    $wechat-&gt;server-&gt;setMessageHandler(function ($message) use ($userApi) &#123;</div><div class=\"line\">        switch ($message-&gt;MsgType) &#123;</div><div class=\"line\">            case &apos;event&apos;:</div><div class=\"line\">                if ($message-&gt;Event == &apos;subscribe&apos;) &#123;</div><div class=\"line\">                    return &quot;欢迎关注！&quot;;</div><div class=\"line\">                    break;</div><div class=\"line\">                &#125;</div><div class=\"line\">                if ($message-&gt;Event == &apos;unsubscribe&apos;) &#123;</div><div class=\"line\">                    \\Log::info(&apos;取消订阅&apos;);</div><div class=\"line\"></div><div class=\"line\">                    return &quot;取消订阅！&quot;;</div><div class=\"line\">                    break;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                return &apos;收到事件消息&apos;;</div><div class=\"line\">                break;</div><div class=\"line\">            case &apos;text&apos;:</div><div class=\"line\">                if ($message-&gt;Content == &apos;test&apos;) &#123;</div><div class=\"line\">                    return &apos;test&apos;;</div><div class=\"line\">                    break;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                return &apos;你好 &apos;.$userApi-&gt;get($message-&gt;FromUserName)-&gt;nickname;</div><div class=\"line\">                break;</div><div class=\"line\">            case &apos;image&apos;:</div><div class=\"line\">                return &apos;收到图片消息&apos;;</div><div class=\"line\">                break;</div><div class=\"line\">            case &apos;voice&apos;:</div><div class=\"line\">                return &apos;收到语音消息&apos;;</div><div class=\"line\">                break;</div><div class=\"line\">            case &apos;video&apos;:</div><div class=\"line\">                return &apos;收到视频消息&apos;;</div><div class=\"line\">                break;</div><div class=\"line\">            case &apos;location&apos;:</div><div class=\"line\">                return &apos;收到坐标消息&apos;;</div><div class=\"line\">                break;</div><div class=\"line\">            case &apos;link&apos;:</div><div class=\"line\">                return &apos;收到链接消息&apos;;</div><div class=\"line\">                break;</div><div class=\"line\">            // ... 其它消息</div><div class=\"line\">            default:</div><div class=\"line\">                return &apos;收到其它消息&apos;;</div><div class=\"line\">                break;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;);</div><div class=\"line\"></div><div class=\"line\">    return $wechat-&gt;server-&gt;serve();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<blockquote>\n<p><a href=\"https://easywechat.org/zh-cn/docs/server.html#基本使用\" target=\"_blank\" rel=\"external\">EasyWechat 消息处理基本使用</a><br>\\Log::info(‘取消订阅’);  调试时可以用 tail 动态查看日志，例如<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ echo &apos;&apos; &gt; /path/project/storage/logs/laravel.log &amp;&amp; tail -n 20 -f /path/project/storage/logs/laravel.log</div><div class=\"line\">[2017-06-05 17:20:07] local.INFO: 取消订阅</div></pre></td></tr></table></figure></p>\n</blockquote>\n<h2 id=\"用户信息\"><a href=\"#用户信息\" class=\"headerlink\" title=\"用户信息\"></a>用户信息</h2><p>project\\app\\Http\\Controllers\\Wechat\\WxUsersController.php<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ php artisan make:controller Wechat/WxUsersController #微信用户管理控制器</div><div class=\"line\"></div><div class=\"line\">project\\app\\Http\\Controllers\\Wechat\\WxUsersController.php</div><div class=\"line\"></div><div class=\"line\">&lt;?php</div><div class=\"line\">namespace App\\Http\\Controllers\\Wechat;</div><div class=\"line\"></div><div class=\"line\">use EasyWeChat\\Foundation\\Application;</div><div class=\"line\">use App\\Http\\Controllers\\Controller;</div><div class=\"line\"></div><div class=\"line\">class WxUsersController extends Controller</div><div class=\"line\">&#123;</div><div class=\"line\">    protected $wechat;</div><div class=\"line\">    </div><div class=\"line\">    public function __construct(Application $wechat)</div><div class=\"line\">    &#123;</div><div class=\"line\">        $this-&gt;wechat = $wechat;</div><div class=\"line\">    &#125;</div><div class=\"line\">    </div><div class=\"line\">    //根据 openid 获取用户信息</div><div class=\"line\">    public function user($openid)</div><div class=\"line\">    &#123;</div><div class=\"line\">        $user = $this-&gt;wechat-&gt;user-&gt;get($openid);</div><div class=\"line\">        return $user;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"微信支付二维码扫描\"><a href=\"#微信支付二维码扫描\" class=\"headerlink\" title=\"微信支付二维码扫描\"></a>微信支付二维码扫描</h2><p>虽然文档上面有这篇<a href=\"https://laravel-china.org/topics/3146/tutorial-based-on-the-laravel51-version-of-wechat-lts-development\" target=\"_blank\" rel=\"external\">【教程】基于 Laravel5.1 LTS 版的微信开发</a>，然而作者还是有很多没说出来的坑!!!(可能是我比较菜的原因)</p>\n<ul>\n<li>首先装个二维码组件 <a href=\"https://www.simplesoftware.io/docs/simple-qrcode/zh#docs-configuration\" target=\"_blank\" rel=\"external\">Simple QrCode</a></li>\n<li>新建控制器 <code>$ php artisan make:controller WxpayController</code><br>project\\app\\Http\\Controllers\\WxpayController.php</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?php</div><div class=\"line\"></div><div class=\"line\">namespace App\\Http\\Controllers;</div><div class=\"line\"></div><div class=\"line\">use EasyWeChat\\Foundation\\Application;</div><div class=\"line\">use EasyWeChat\\Payment\\Order;</div><div class=\"line\">use Illuminate\\Http\\Request;</div><div class=\"line\">use SimpleSoftwareIO\\QrCode\\Facades\\QrCode;</div><div class=\"line\"></div><div class=\"line\">class WxpayController extends Controller</div><div class=\"line\">&#123;</div><div class=\"line\">    protected $wechat;</div><div class=\"line\"></div><div class=\"line\">    public function __construct(Application $wechat)</div><div class=\"line\">    &#123;</div><div class=\"line\">        //依赖注入</div><div class=\"line\">        $this-&gt;wechat = $wechat;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    //生成订单</div><div class=\"line\">    public function order(Request $request)</div><div class=\"line\">    &#123;</div><div class=\"line\">        $attributes = [</div><div class=\"line\">            &apos;trade_type&apos; =&gt; &apos;NATIVE&apos;, // JSAPI，NATIVE，APP...</div><div class=\"line\">            &apos;body&apos; =&gt; &apos;iPad mini 16G 白色&apos;,</div><div class=\"line\">            &apos;detail&apos; =&gt; &apos;iPad mini 16G 白色&apos;,</div><div class=\"line\">            &apos;out_trade_no&apos; =&gt; &apos;1217752501201407033233368018&apos;,</div><div class=\"line\">            &apos;total_fee&apos; =&gt; $request-&gt;get(&apos;money&apos;) * 100, // 单位：分</div><div class=\"line\">            &apos;notify_url&apos; =&gt; &apos;http://xxx/notify&apos;, // 支付结果通知网址，如果不设置则会使用配置里的默认地址</div><div class=\"line\">            //&apos;openid&apos; =&gt; &apos;当前用户的 openid&apos;, // trade_type=JSAPI，此参数必传，用户在商户appid下的唯一标识，</div><div class=\"line\">            // ...</div><div class=\"line\">        ];</div><div class=\"line\"></div><div class=\"line\">        $payment = $this-&gt;wechat-&gt;payment;</div><div class=\"line\">        $order = new Order($attributes);</div><div class=\"line\">        $result = $payment-&gt;prepare($order);</div><div class=\"line\">        \\Log::info($result); //生成订单时可以打印看看有什么错没</div><div class=\"line\">        if ($result-&gt;return_code == &apos;SUCCESS&apos; &amp;&amp; $result-&gt;result_code == &apos;SUCCESS&apos;) &#123;</div><div class=\"line\">            $ajax_data = [</div><div class=\"line\">                &apos;html&apos; =&gt; json_encode(QrCode::size(250)-&gt;generate($result[&apos;code_url&apos;])),</div><div class=\"line\">                &apos;price&apos; =&gt; $attributes[&apos;total_fee&apos;] / 100,</div><div class=\"line\">            ];</div><div class=\"line\"></div><div class=\"line\">            return $ajax_data;</div><div class=\"line\">        &#125; else &#123;</div><div class=\"line\">            die(&quot;出错了。&quot;);  // 出错就说出来，不然还能怎样？</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<blockquote>\n<p>关于<code>trade_type</code>看官方文档熟悉下参数的用途 <a href=\"https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_1\" target=\"_blank\" rel=\"external\">统一下单</a> 看下请求参数，里面指出了用户标识<code>openid</code>不是必传，所以我们得选 <code>NATIVE</code> 而不是<code>JSAPI</code>,我还很纠结这<code>openid</code>怎么获取，没想到这个其实是<code>JSAPI</code>时才需要传的参数，所以还是得多看下官方文档。</p>\n<p>关于<code>total_fee</code>参数，这个是以分为单位，所以需要乘100，不然传0.01时会报错，取出来是自然要除以100了。</p>\n<p>关于返回的<code>$ajax_data</code>数据，上面那篇教程里面有个<code>$data-&gt;order_guid,$data-&gt;price</code> 这2个数据其实是他在别的地方定义的，也就是返回唯一订单号跟价钱，传不传无所谓，只要有二维码就行了，不用纠结他是哪来的。</p>\n</blockquote>\n<p>接下来看回调，因为是扫码支付，需要在服务器上做个标志，通过js轮询这个标志，所以我们要建个支付的订单表，不然前台扫码支付后页面不会做任何操作。</p>\n<p>建表</p>\n<blockquote>\n<p><code>$ php artisan make:migration create_pay_users_table</code><br><code>$ php artisan make:migration create_pay_orders_table</code></p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div></pre></td><td class=\"code\"><pre><div class=\"line\">project\\database\\migrations\\2017_06_13_180443_create_pay_users_table.php</div><div class=\"line\"></div><div class=\"line\">public function up()</div><div class=\"line\">&#123;</div><div class=\"line\">    Schema::create(&apos;pay_users&apos;, function (Blueprint $table) &#123;</div><div class=\"line\">        $table-&gt;increments(&apos;id&apos;);</div><div class=\"line\">        $table-&gt;string(&apos;user_id&apos;)-&gt;comment(&apos;用户id&apos;);</div><div class=\"line\">        $table-&gt;string(&apos;nickname&apos;)-&gt;nullable()-&gt;comment(&apos;用户昵称&apos;);</div><div class=\"line\">        $table-&gt;string(&apos;avatar&apos;)-&gt;nullable()-&gt;comment(&apos;用户头像&apos;);</div><div class=\"line\">        $table-&gt;string(&apos;pay_type&apos;)-&gt;comment(&apos;支付方式&apos;);</div><div class=\"line\">        $table-&gt;timestamps();</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div><div class=\"line\">public function down()</div><div class=\"line\">&#123;</div><div class=\"line\">    Schema::dropIfExists(&apos;pay_users&apos;);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">project\\database\\migrations\\2017_06_13_181502_create_pay_orders_table.php</div><div class=\"line\"></div><div class=\"line\">public function up()</div><div class=\"line\">&#123;</div><div class=\"line\">    Schema::create(&apos;pay_orders&apos;, function (Blueprint $table) &#123;</div><div class=\"line\">        $table-&gt;increments(&apos;id&apos;);</div><div class=\"line\">        $table-&gt;string(&apos;user_id&apos;)-&gt;comment(&apos;阿里账号或微信open_id&apos;);</div><div class=\"line\">        $table-&gt;integer(&apos;p_id&apos;)-&gt;comment(&apos;产品id&apos;);</div><div class=\"line\">        $table-&gt;string(&apos;order_guid&apos;)-&gt;comment(&apos;订单号&apos;);</div><div class=\"line\">        $table-&gt;string(&apos;pay_money&apos;)-&gt;comment(&apos;支付金额&apos;);</div><div class=\"line\">        $table-&gt;integer(&apos;order_status&apos;)-&gt;comment(&apos;支付状态&apos;);</div><div class=\"line\">        $table-&gt;string(&apos;pay_type&apos;)-&gt;comment(&apos;支付类型&apos;);</div><div class=\"line\">        $table-&gt;integer(&apos;paid_at&apos;)-&gt;nullable()-&gt;comment(&apos;支付时间&apos;);</div><div class=\"line\">        $table-&gt;timestamps();</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div><div class=\"line\">public function down()</div><div class=\"line\">&#123;</div><div class=\"line\">    Schema::dropIfExists(&apos;pay_orders&apos;);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$ php artisan migrate</div></pre></td></tr></table></figure>\n<p>以下是完整的<code>WxPayController</code>的代码,操作用户信息的代码可用可不用，我是项目需要</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?php</div><div class=\"line\"></div><div class=\"line\">namespace App\\Http\\Controllers;</div><div class=\"line\"></div><div class=\"line\">use EasyWeChat\\Foundation\\Application;</div><div class=\"line\">use EasyWeChat\\Payment\\Order;</div><div class=\"line\">use Illuminate\\Http\\Request;</div><div class=\"line\">use SimpleSoftwareIO\\QrCode\\Facades\\QrCode;</div><div class=\"line\">use Log;</div><div class=\"line\">use App\\Models\\PayUser;</div><div class=\"line\">use App\\Models\\PayOrder;</div><div class=\"line\"></div><div class=\"line\">class WxpayController extends Controller</div><div class=\"line\">&#123;</div><div class=\"line\">    protected $wechat;</div><div class=\"line\"></div><div class=\"line\">    protected $payment;</div><div class=\"line\"></div><div class=\"line\">    public function __construct(Application $wechat)</div><div class=\"line\">    &#123;</div><div class=\"line\">        //依赖注入</div><div class=\"line\">        $this-&gt;wechat = $wechat;</div><div class=\"line\">        $this-&gt;payment = $this-&gt;wechat-&gt;payment;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    //生成订单</div><div class=\"line\">    public function order(Request $request)</div><div class=\"line\">    &#123;</div><div class=\"line\">        $out_trade_no = &apos;xxx&apos;.date(&quot;YmdHis&quot;);</div><div class=\"line\">        $attributes = [</div><div class=\"line\">            &apos;trade_type&apos; =&gt; &apos;NATIVE&apos;, // JSAPI，NATIVE，APP...</div><div class=\"line\">            &apos;body&apos; =&gt; &apos;iPad mini 16G 白色&apos;,</div><div class=\"line\">            &apos;detail&apos; =&gt; &apos;iPad mini 16G 白色&apos;,</div><div class=\"line\">            &apos;out_trade_no&apos; =&gt; $out_trade_no,</div><div class=\"line\">            &apos;total_fee&apos; =&gt; $request-&gt;get(&apos;money&apos;) * 100, // 单位：分</div><div class=\"line\">            &apos;notify_url&apos; =&gt; &apos;http://m.lidetang.org/wechat/pc/notify&apos;, // 支付结果通知网址，如果不设置则会使用配置里的默认地址</div><div class=\"line\">            //&apos;openid&apos; =&gt; &apos;当前用户的 openid&apos;, // trade_type=JSAPI，此参数必传，用户在商户appid下的唯一标识，</div><div class=\"line\">            // ...</div><div class=\"line\">        ];</div><div class=\"line\"></div><div class=\"line\">        $order = new Order($attributes);</div><div class=\"line\">        $result = $this-&gt;payment-&gt;prepare($order);</div><div class=\"line\">        Log::info($result);</div><div class=\"line\">        //如果微信订单生成成功</div><div class=\"line\">        if ($result-&gt;return_code == &apos;SUCCESS&apos; &amp;&amp; $result-&gt;result_code == &apos;SUCCESS&apos;) &#123;</div><div class=\"line\">            //创建未支付订单信息</div><div class=\"line\">            $order_info = [</div><div class=\"line\">                &apos;user_id&apos; =&gt; &apos;no_id&apos;,</div><div class=\"line\">                &apos;p_id&apos; =&gt; &apos;5&apos;,</div><div class=\"line\">                &apos;order_guid&apos; =&gt; $out_trade_no,</div><div class=\"line\">                &apos;pay_money&apos; =&gt; $attributes[&apos;total_fee&apos;] / 100,</div><div class=\"line\">                &apos;order_status&apos; =&gt; 0,</div><div class=\"line\">                &apos;pay_type&apos; =&gt; &apos;wechat&apos;,</div><div class=\"line\">            ];</div><div class=\"line\">            Log::info(&apos;未支付订单详情：&apos;);</div><div class=\"line\">            Log::debug($order_info);</div><div class=\"line\">            //创建未支付订单</div><div class=\"line\">            PayOrder::create($order_info);</div><div class=\"line\">            //ajax返回数据</div><div class=\"line\">            $ajax_data = [</div><div class=\"line\">                &apos;html&apos; =&gt; json_encode(QrCode::size(250)-&gt;generate($result[&apos;code_url&apos;])),</div><div class=\"line\">                &apos;order_guid&apos; =&gt; $order_info[&apos;order_guid&apos;],</div><div class=\"line\">                &apos;price&apos; =&gt; $order_info[&apos;pay_money&apos;],</div><div class=\"line\"></div><div class=\"line\">            ];</div><div class=\"line\"></div><div class=\"line\">            return $ajax_data;</div><div class=\"line\">        &#125; else &#123;</div><div class=\"line\">            die(&quot;出错了。&quot;);  // 出错就说出来，不然还能怎样？</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    //支付回调函数</div><div class=\"line\">    public function notifyUrl()</div><div class=\"line\">    &#123;</div><div class=\"line\">        Log::info(&apos;进入回调&apos;);</div><div class=\"line\">        $response = $this-&gt;payment-&gt;handleNotify(function ($notify, $successful) &#123;</div><div class=\"line\">            //查数据库看这个订单是否存在</div><div class=\"line\">            $order = PayOrder::where(&apos;order_guid&apos;, $notify-&gt;out_trade_no)-&gt;first();</div><div class=\"line\">            Log::info(&apos;订单号&apos;);</div><div class=\"line\">            Log::debug($notify-&gt;out_trade_no);</div><div class=\"line\">            Log::debug($order);</div><div class=\"line\">            // 如果订单不存在</div><div class=\"line\">            if (! $order) &#123;</div><div class=\"line\">                Log::info(&apos;订单没有存在&apos;);</div><div class=\"line\">                Log::info(&apos;回调中未支付订单信息&apos;);</div><div class=\"line\">                Log::debug($order);</div><div class=\"line\"></div><div class=\"line\">                return false; // 告诉微信，我已经处理完了，订单没找到，别再通知我了</div><div class=\"line\">            &#125; else &#123;</div><div class=\"line\">                // 如果订单存在</div><div class=\"line\">                // 检查订单是否已经更新过支付状态</div><div class=\"line\">                if ($order-&gt;paid_at !== null) &#123; // 假设订单字段“支付时间”不为空代表已经支付</div><div class=\"line\">                    Log::info(&apos;回调中未支付订单信息&apos;);</div><div class=\"line\">                    Log::debug($order);</div><div class=\"line\">                    Log::info(&apos;订单存在支付时间:&apos;);</div><div class=\"line\">                    Log::info($order-&gt;paid_at);</div><div class=\"line\"></div><div class=\"line\">                    return true; // 已经支付成功了就不再更新了</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">            $userService = $this-&gt;wechat-&gt;user;</div><div class=\"line\">            // 用户是否支付成功</div><div class=\"line\">            if ($successful) &#123;</div><div class=\"line\">                Log::info(&apos;进入支付&apos;);</div><div class=\"line\">                /*</div><div class=\"line\">                 * 记录用户信息</div><div class=\"line\">                 */</div><div class=\"line\">                $user_info = $userService-&gt;get($notify-&gt;openid);</div><div class=\"line\">                //查找支付用户信息</div><div class=\"line\">                Log::info(&apos;查找支付用户信息&apos;);</div><div class=\"line\">                $user = PayUser::where(&apos;user_id&apos;, $notify-&gt;openid)-&gt;first();</div><div class=\"line\">                //如果没有这个用户</div><div class=\"line\">                if (! $user) &#123;</div><div class=\"line\">                    Log::info(&apos;没有这个用户的信息&apos;);</div><div class=\"line\">                    //如果有订阅</div><div class=\"line\">                    if ($user_info-&gt;subscribe) &#123;</div><div class=\"line\">                        Log::info(&apos;用户有订阅:&apos;.$user_info-&gt;subscribe);</div><div class=\"line\">                        $data = [</div><div class=\"line\">                            &apos;user_id&apos; =&gt; $notify-&gt;openid,</div><div class=\"line\">                            &apos;nickname&apos; =&gt; $user_info-&gt;nickname,</div><div class=\"line\">                            &apos;avatar&apos; =&gt; $user_info-&gt;headimgurl,</div><div class=\"line\">                            &apos;pay_type&apos; =&gt; &apos;wechat&apos;,</div><div class=\"line\">                        ];</div><div class=\"line\">                        //创建用户信息</div><div class=\"line\">                        Log::info(&apos;订阅用户的信息&apos;);</div><div class=\"line\">                        Log::debug($data);</div><div class=\"line\">                        PayUser::create($data);</div><div class=\"line\">                    &#125; else &#123; //否则设置默认信息</div><div class=\"line\">                        Log::info(&apos;用户没有订阅：&apos;.$user_info-&gt;subscribe);</div><div class=\"line\">                        $data = [</div><div class=\"line\">                            &apos;user_id&apos; =&gt; $notify-&gt;openid,</div><div class=\"line\">                            &apos;nickname&apos; =&gt; &apos;爱心人士&apos;,</div><div class=\"line\">                            &apos;avatar&apos; =&gt; &apos;/images/avatar/pay.jpg&apos;,</div><div class=\"line\">                            &apos;pay_type&apos; =&gt; &apos;wechat&apos;,</div><div class=\"line\">                        ];</div><div class=\"line\">                        Log::debug($data);</div><div class=\"line\">                        //创建默认用户信息</div><div class=\"line\">                        PayUser::create($data);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125; else &#123; //如果有这个用户</div><div class=\"line\">                    //查看订阅情况</div><div class=\"line\">                    Log::info(&apos;已存在该用户信息&apos;);</div><div class=\"line\">                    if ($user_info-&gt;subscribe) &#123;</div><div class=\"line\">                        //更新用户信息</div><div class=\"line\">                        Log::info(&apos;用户有订阅&apos;.$user_info-&gt;subscribe);</div><div class=\"line\">                        $user-&gt;nickname = $user_info-&gt;nickname;</div><div class=\"line\">                        $user-&gt;avatar = $user_info-&gt;headimgurl;</div><div class=\"line\">                        $user-&gt;save();</div><div class=\"line\">                        Log::info(&apos;更新用户信息&apos;);</div><div class=\"line\">                        Log::debug($user);</div><div class=\"line\">                    &#125;</div><div class=\"line\">                &#125;</div><div class=\"line\">                //更新未支付订单信息，标志order_status为1，已支付</div><div class=\"line\">                Log::info(&apos;用户信息处理完毕&apos;);</div><div class=\"line\">                $order-&gt;user_id = $notify-&gt;openid;</div><div class=\"line\">                $order-&gt;paid_at = time();</div><div class=\"line\">                $order-&gt;order_status = 1;</div><div class=\"line\">            &#125; else &#123;</div><div class=\"line\">                $order-&gt;order_status = 0;</div><div class=\"line\">            &#125;</div><div class=\"line\">            $order-&gt;save(); // 保存订单</div><div class=\"line\">            Log::info(&apos;更新订单支付状态&apos;);</div><div class=\"line\">            Log::debug($order);</div><div class=\"line\"></div><div class=\"line\">            return true; // 返回处理完成</div><div class=\"line\"></div><div class=\"line\">        &#125;);</div><div class=\"line\">        Log::info(&apos;回调结束&apos;);</div><div class=\"line\"></div><div class=\"line\">        return $response;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    public function getOrderStatus(Request $request)</div><div class=\"line\">    &#123;</div><div class=\"line\">        $pay_status = PayOrder::where(&apos;order_guid&apos;, $request-&gt;get(&apos;order_guid&apos;))-&gt;value(&apos;order_status&apos;);</div><div class=\"line\"></div><div class=\"line\">        return [&apos;pay_status&apos; =&gt; $pay_status];</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>附加路由<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">//支付详情页</div><div class=\"line\">Route::get(&apos;/pay_details/&#123;id&#125;&apos;, &apos;HomeController@pay_details&apos;);</div><div class=\"line\">//wechat QrCode Scan pay</div><div class=\"line\">Route::post(&apos;/wechat/pay&apos;, &apos;WxpayController@order&apos;);</div><div class=\"line\">Route::any(&apos;/wechat/pc/notify&apos;, &apos;WxpayController@notifyUrl&apos;);</div><div class=\"line\">Route::post(&apos;/wechat/orderStatus&apos;,&apos;WxpayController@getOrderStatus&apos;);</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">//支付详情</div><div class=\"line\">public function pay_details(Request $request)</div><div class=\"line\">&#123;</div><div class=\"line\">    return view(&apos;pay.pay_details&apos;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p><a href=\"https://gist.github.com/wploey/9e4ebeadd4c31e7e6f645156aec28ba9\" target=\"_blank\" rel=\"external\">pay.pay_details.blade.php 代码</a></p>\n<p>效果图<br><img src=\"http://oqlezeown.bkt.clouddn.com/qr-scan-pay-preview.png\" alt=\"\"></p>\n<h2 id=\"支付宝即时到账\"><a href=\"#支付宝即时到账\" class=\"headerlink\" title=\"支付宝即时到账\"></a>支付宝即时到账</h2><p><a href=\"https://github.com/latrell/Alipay\" target=\"_blank\" rel=\"external\">latrell/Alipay</a> 安装好了按照文档写上对应代码就可以用了</p>\n<h2 id=\"微信网页授权\"><a href=\"#微信网页授权\" class=\"headerlink\" title=\"微信网页授权\"></a>微信网页授权</h2><p>按照 EasyWeChat 文档配置 OAuth2.0</p>\n<h2 id=\"微信JSAPI支付\"><a href=\"#微信JSAPI支付\" class=\"headerlink\" title=\"微信JSAPI支付\"></a>微信JSAPI支付</h2><p>同微信支付二维码扫描差不多，需要根据<code>OAuth2.0</code>获取<code>opendi</code>生成订单</p>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><blockquote>\n<p><a href=\"https://easywechat.org/zh-cn/docs/payment.html\" target=\"_blank\" rel=\"external\">EasyWeChat 支付</a><br><a href=\"https://laravel-china.org/topics/3146/tutorial-based-on-the-laravel51-version-of-wechat-lts-development\" target=\"_blank\" rel=\"external\">【教程】基于 Laravel5.1 LTS 版的微信开发</a><br><a href=\"http://blog.csdn.net/amazingdyd/article/details/59483697\" target=\"_blank\" rel=\"external\">Laravel使用EasyWechat，3分钟完成微信APP支付</a><br>相关资料<br><a href=\"http://www.cnblogs.com/raincedar/p/5653584.html\" target=\"_blank\" rel=\"external\">微信扫码支付模式一和模式二的区别</a></p>\n</blockquote>\n","thumbnail":"http://oqlezeown.bkt.clouddn.com/image/laravel-easywechat-pay/Sunset-Village-Wallpaper_8I7ogbf.jpg","primarycolor":"blueGrey","accentcolor":"blueGrey","categories":[{"name":"技术","path":"api/categories/技术.json"}],"tags":[{"name":"EasyWechat","path":"api/tags/EasyWechat.json"},{"name":"Pay","path":"api/tags/Pay.json"},{"name":"laravel","path":"api/tags/laravel.json"}]}